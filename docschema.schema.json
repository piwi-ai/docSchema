{
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "$id": "https://docschema.org/v1/business-configuration.schema.json",
    "title": "DocSchema Business Configuration",
    "description": "An open standard for AI-readable document schemas. Defines document types, entity types, and cross-document validation rules for a specific business vertical.",
    "type": "object",
    "required": [
        "id",
        "name",
        "description",
        "schemaVersion",
        "documentTypes",
        "entityTypes"
    ],
    "additionalProperties": false,
    "properties": {
        "id": {
            "type": "string",
            "description": "Unique configuration identifier. Convention: {VERTICAL}-{COUNTRY}-DEFAULT",
            "pattern": "^[A-Z][A-Z0-9-]+$",
            "examples": [
                "REAL-ESTATE-IT-DEFAULT",
                "ACCOUNTANT-IT-DEFAULT",
                "REAL-ESTATE-US-DEFAULT"
            ]
        },
        "name": {
            "type": "string",
            "description": "Human-readable configuration name",
            "examples": [
                "Italian Real Estate",
                "US Real Estate"
            ]
        },
        "description": {
            "type": "string",
            "description": "Description of the business vertical and country"
        },
        "schemaVersion": {
            "type": "integer",
            "const": 1,
            "description": "Schema version for forward compatibility. Currently must be 1."
        },
        "documentTypes": {
            "type": "array",
            "description": "Document type definitions with JSON Schema extraction instructions",
            "minItems": 1,
            "items": {
                "$ref": "#/$defs/DocumentTypeDef"
            }
        },
        "entityTypes": {
            "type": "array",
            "description": "Entity type definitions with aggregation and validation rules",
            "items": {
                "$ref": "#/$defs/EntityTypeDef"
            }
        }
    },
    "$defs": {
        "DocumentTypeDef": {
            "type": "object",
            "description": "Defines a document category and the JSON Schema describing extractable fields.",
            "required": [
                "id",
                "name",
                "jsonSchema"
            ],
            "additionalProperties": false,
            "properties": {
                "id": {
                    "type": "string",
                    "description": "Unique identifier, prefixed with 'doc-'",
                    "pattern": "^doc-[a-z][a-z0-9-]*$",
                    "examples": [
                        "doc-fattura",
                        "doc-drivers-license",
                        "doc-identita"
                    ]
                },
                "name": {
                    "type": "string",
                    "description": "Human-readable document type name"
                },
                "description": {
                    "type": "string",
                    "description": "What this document type represents"
                },
                "jsonSchema": {
                    "type": "object",
                    "description": "JSON Schema defining the extractable fields. Must have type: 'object' with properties and required.",
                    "required": [
                        "type",
                        "properties",
                        "required"
                    ],
                    "properties": {
                        "type": {
                            "const": "object"
                        },
                        "properties": {
                            "type": "object"
                        },
                        "required": {
                            "type": "array",
                            "items": {
                                "type": "string"
                            }
                        }
                    }
                },
                "isArrayExtraction": {
                    "type": "boolean",
                    "default": false,
                    "description": "If true, extraction returns an array of objects (for documents containing data about multiple entities)"
                }
            }
        },
        "MatchFieldConfig": {
            "type": "object",
            "description": "Defines how to match a document's extracted field to an entity field for identity resolution.",
            "required": [
                "field"
            ],
            "additionalProperties": false,
            "properties": {
                "field": {
                    "type": "string",
                    "description": "Entity field name to match on (e.g. 'codiceFiscale', 'nome')"
                },
                "fuzzyThreshold": {
                    "type": "number",
                    "minimum": 0,
                    "maximum": 1,
                    "default": 0,
                    "description": "Fuzzy matching tolerance: 0 = exact, 0.2 = minor typos, 1 = match anything"
                },
                "operator": {
                    "type": "string",
                    "enum": [
                        "equals",
                        "contains",
                        "exists"
                    ],
                    "description": "Comparison operator (used for condition edges)"
                },
                "value": {
                    "type": "string",
                    "description": "Value to compare against (used with operator)"
                }
            }
        },
        "EntityFieldMapping": {
            "type": "object",
            "description": "Maps a field from extracted document data to an entity field.",
            "required": [
                "sourceField",
                "targetField"
            ],
            "additionalProperties": false,
            "properties": {
                "sourceField": {
                    "type": "string",
                    "description": "Path in the document's extracted data. Supports dot notation for nested/array fields (e.g. 'venditori.nome')"
                },
                "targetField": {
                    "type": "string",
                    "description": "Field name on the entity (e.g. 'nome')"
                },
                "matchFields": {
                    "type": "array",
                    "description": "Rules for matching this document to an existing entity",
                    "items": {
                        "$ref": "#/$defs/MatchFieldConfig"
                    }
                }
            }
        },
        "EntityDataSource": {
            "type": "object",
            "description": "Defines which document type provides data for an entity type, and how fields are mapped.",
            "required": [
                "docTypeId",
                "fieldMappings"
            ],
            "additionalProperties": false,
            "properties": {
                "docTypeId": {
                    "type": "string",
                    "description": "Document type ID that provides data",
                    "pattern": "^doc-[a-z][a-z0-9-]*$"
                },
                "isRequired": {
                    "type": "boolean",
                    "default": false,
                    "description": "If true, this document is always required for the entity"
                },
                "fieldMappings": {
                    "type": "array",
                    "description": "Field-level mappings from document â†’ entity",
                    "minItems": 1,
                    "items": {
                        "$ref": "#/$defs/EntityFieldMapping"
                    }
                },
                "canCreateEntity": {
                    "type": "boolean",
                    "default": false,
                    "description": "If true, this document can create new entities (vs. only enriching existing ones)"
                },
                "enabled": {
                    "type": "boolean",
                    "default": true,
                    "description": "If false, this data source is ignored during aggregation"
                }
            }
        },
        "DocumentCondition": {
            "type": "object",
            "description": "A condition evaluated against a source document's extracted data.",
            "required": [
                "sourceDocTypeId",
                "field",
                "operator"
            ],
            "additionalProperties": false,
            "properties": {
                "sourceDocTypeId": {
                    "type": "string",
                    "description": "Document type to evaluate the condition against",
                    "pattern": "^doc-[a-z][a-z0-9-]*$"
                },
                "field": {
                    "type": "string",
                    "description": "Field path in the source document (supports dot notation)"
                },
                "operator": {
                    "type": "string",
                    "enum": [
                        "equals",
                        "contains",
                        "exists"
                    ],
                    "description": "equals = exact match, contains = substring (case-insensitive), exists = field is non-empty"
                },
                "value": {
                    "type": "string",
                    "description": "Value to compare against. Not needed for 'exists' operator."
                }
            }
        },
        "ConditionalRequirement": {
            "type": "object",
            "description": "Defines when a document type is conditionally required for an entity. Multiple conditions use OR logic.",
            "required": [
                "docTypeId"
            ],
            "additionalProperties": false,
            "properties": {
                "docTypeId": {
                    "type": "string",
                    "description": "Document type that becomes required when conditions are met",
                    "pattern": "^doc-[a-z][a-z0-9-]*$"
                },
                "matchFields": {
                    "type": "array",
                    "description": "Fields used to match the required document to the entity. Empty = folder-level check.",
                    "items": {
                        "$ref": "#/$defs/MatchFieldConfig"
                    }
                },
                "conditions": {
                    "type": "array",
                    "description": "Conditions that trigger this requirement. Empty = always required. Multiple = OR logic.",
                    "items": {
                        "$ref": "#/$defs/DocumentCondition"
                    }
                },
                "enabled": {
                    "type": "boolean",
                    "default": true,
                    "description": "If false, this requirement is skipped during validation"
                }
            }
        },
        "EntityTypeDef": {
            "type": "object",
            "description": "Defines an entity type that aggregates data from multiple documents and validates cross-document requirements.",
            "required": [
                "id",
                "name"
            ],
            "additionalProperties": false,
            "properties": {
                "id": {
                    "type": "string",
                    "description": "Unique identifier, prefixed with 'entity-'",
                    "pattern": "^entity-[a-z][a-z0-9-]*$",
                    "examples": [
                        "entity-venditore",
                        "entity-buyer",
                        "entity-immobile"
                    ]
                },
                "name": {
                    "type": "string",
                    "description": "Human-readable entity type name"
                },
                "icon": {
                    "type": "string",
                    "description": "Icon name for UI rendering (e.g. 'user-minus', 'home', 'banknote')"
                },
                "color": {
                    "type": "string",
                    "description": "Color hex code for UI rendering",
                    "pattern": "^#[0-9a-fA-F]{6}$"
                },
                "fieldOrder": {
                    "type": "array",
                    "description": "Ordered list of entity field names for display",
                    "items": {
                        "type": "string"
                    }
                },
                "dataSources": {
                    "type": "array",
                    "description": "Document types that provide data for this entity (aggregation config)",
                    "items": {
                        "$ref": "#/$defs/EntityDataSource"
                    }
                },
                "conditionalRequirements": {
                    "type": "array",
                    "description": "Documents conditionally required for this entity (validation config)",
                    "items": {
                        "$ref": "#/$defs/ConditionalRequirement"
                    }
                },
                "displayOrder": {
                    "type": "integer",
                    "default": 0,
                    "description": "Display order in UI (lower = shown first)"
                }
            }
        }
    }
}